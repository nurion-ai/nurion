{% extends "base.html" %}

{% block title %}Job {{ job.job_id }}{% endblock %}

{% block content %}
<article class="compact">
    <header>
        <nav aria-label="breadcrumb" style="font-size: 0.75rem;">
            <ul>
                <li><a href="/solstice/">Jobs</a></li>
                <li>{{ job.job_id }}</li>
            </ul>
        </nav>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <h1>{{ job.job_id }}</h1>
            <span class="badge badge-{{ job.status|lower }}">{{ job.status }}</span>
        </div>
    </header>
    
    <!-- Tabs -->
    <nav style="margin-bottom: 0.5rem;">
        <ul>
            <li><a href="/solstice/jobs/{{ job.job_id }}/" role="button" class="small outline">Overview</a></li>
            <li><a href="/solstice/jobs/{{ job.job_id }}/exceptions" role="button" class="small outline">Exceptions</a></li>
            <li><a href="/solstice/jobs/{{ job.job_id }}/checkpoints" role="button" class="small outline">Checkpoints</a></li>
            <li><a href="/solstice/jobs/{{ job.job_id }}/lineage" role="button" class="small outline">Lineage</a></li>
        </ul>
    </nav>
    
    <!-- Job Metrics -->
    <section>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">{{ job.stage_count }}</div>
                <div class="metric-label">Stages</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ job.worker_count }}</div>
                <div class="metric-label">Workers</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ (job.last_update - job.start_time)|format_duration }}</div>
                <div class="metric-label">Duration</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ job.start_time|format_datetime }}</div>
                <div class="metric-label">Started</div>
            </div>
        </div>
    </section>
    
    <!-- Stages Table -->
    <section>
        <h2>Stages</h2>
        {% if stages %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 30%;">Stage ID</th>
                        <th style="width: 12%;">Workers</th>
                        <th style="width: 12%;">Queue</th>
                        <th style="width: 12%;">In</th>
                        <th style="width: 12%;">Out</th>
                        <th style="width: 12%;">Status</th>
                        <th style="width: 10%;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stage in stages %}
                    <tr>
                        <td class="monospace">
                            <a href="/solstice/jobs/{{ job.job_id }}/stages/{{ stage.stage_id }}">{{ stage.stage_id }}</a>
                        </td>
                        <td class="number">{{ stage.worker_count }}</td>
                        <td class="number">{{ stage.output_queue_size|format_number }}</td>
                        <td class="number">{{ stage.input_count|default(0)|format_number }}</td>
                        <td class="number">{{ stage.output_count|default(0)|format_number }}</td>
                        <td>
                            {% if stage.is_running %}
                            <span class="badge badge-running">RUN</span>
                            {% elif stage.is_finished %}
                            <span class="badge badge-completed">DONE</span>
                            {% elif stage.failed %}
                            <span class="badge badge-failed">FAIL</span>
                            {% else %}
                            <span class="badge badge-pending">WAIT</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="/solstice/jobs/{{ job.job_id }}/stages/{{ stage.stage_id }}" class="small">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p><em>No stage information available (data collection starting...)</em></p>
        {% endif %}
    </section>
    
    <!-- External Links -->
    <section>
        <h3>Links</h3>
        <div style="display: flex; gap: 0.3rem;">
            <a href="http://localhost:8265" target="_blank" rel="noopener" role="button" class="outline small">Ray â†—</a>
        </div>
    </section>
</article>
{% endblock %}
