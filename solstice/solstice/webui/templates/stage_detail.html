{% extends "base.html" %}

{% block title %}Stage {{ stage.stage_id }}{% endblock %}

{% block content %}
<article class="compact" 
         hx-get="{{ base_path }}/jobs/{{ job_id }}/stages/{{ stage.stage_id }}" 
         hx-trigger="solstice-poll from:body"
         hx-swap="outerHTML"
         hx-select="article.compact">
    <header>
        <nav aria-label="breadcrumb">
            <ul>
                <li><a href="{{ base_path }}/">Jobs</a></li>
                <li><a href="{{ base_path }}/jobs/{{ job_id }}/">{{ job_id }}</a></li>
                <li>{{ stage.stage_id }}</li>
            </ul>
        </nav>
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem;">
            <h1 style="margin: 0;">Stage: {{ stage.stage_id }}</h1>
            <span class="badge badge-{{ 'running' if stage.is_running else 'completed' if stage.is_finished else 'pending' }}">
                {{ 'RUNNING' if stage.is_running else 'COMPLETED' if stage.is_finished else 'PENDING' }}
            </span>
            {% if stage.backpressure_active %}
            <span class="badge" style="background: var(--pico-warning);">BACKPRESSURE</span>
            {% endif %}
        </div>
    </header>
    
    <!-- Metrics Overview -->
    <section>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">{{ stage.worker_count|default(0) }}</div>
                <div class="metric-label">Workers</div>
                <div class="metric-sublabel">{{ stage.min_parallelism|default('?') }}-{{ stage.max_parallelism|default('?') }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ stage.output_queue_size|default(0)|format_number }}</div>
                <div class="metric-label">Queue Size</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ (stage.input_count|default(stage.input_records if stage.input_records else 0)|default(0))|format_number }}</div>
                <div class="metric-label">Input Records</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{{ (stage.output_count|default(stage.output_records if stage.output_records else 0)|default(0))|format_number }}</div>
                <div class="metric-label">Output Records</div>
            </div>
        </div>
    </section>
    
    <!-- Stage Configuration -->
    <section>
        <details>
            <summary>Configuration</summary>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.25rem 1rem; font-size: 0.85rem;">
                <strong>Operator:</strong> <code>{{ stage.operator_type|default('Unknown') }}</code>
                <strong>Parallelism:</strong> <span>{{ stage.min_parallelism|default('?') }} - {{ stage.max_parallelism|default('?') }}</span>
                {% if stage.num_cpus %}
                <strong>CPUs:</strong> <span>{{ stage.num_cpus }}</span>
                {% endif %}
                {% if stage.num_gpus %}
                <strong>GPUs:</strong> <span>{{ stage.num_gpus }}</span>
                {% endif %}
                {% if stage.memory_mb %}
                <strong>Memory:</strong> <span>{{ stage.memory_mb }} MB</span>
                {% endif %}
            </div>
        </details>
    </section>
    
    <!-- Workers Table -->
    <section>
        <h2>Workers ({{ workers|default([])|length }})</h2>
        {% if workers %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 30%;">Worker ID</th>
                        <th style="width: 12%;">Status</th>
                        <th class="number" style="width: 15%;">Processed</th>
                        <th style="width: 15%;">Partitions</th>
                        <th style="width: 18%;">Links</th>
                    </tr>
                </thead>
                <tbody>
                    {% for worker in workers %}
                    <tr>
                        <td class="monospace" style="font-size: 0.75rem;">
                            <a href="{{ base_path }}/jobs/{{ job_id }}/workers/{{ worker.worker_id }}">
                                {{ worker.worker_id[:16] }}...
                            </a>
                        </td>
                        <td>
                            <span class="badge badge-{{ worker.status|lower }}">{{ worker.status }}</span>
                        </td>
                        <td class="number">{{ worker.processed_count|default(0)|format_number }}</td>
                        <td class="monospace" style="font-size: 0.75rem;">
                            {% if worker.assigned_partitions %}
                            {{ worker.assigned_partitions|join(', ') }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if worker.actor_id %}
                            <a href="http://localhost:8265/#/actors/{{ worker.actor_id }}" target="_blank" class="small">Ray Actor ↗</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p><em>No workers currently running</em></p>
        {% endif %}
    </section>
    
    <!-- Partition Metrics -->
    {% if partition_metrics %}
    <section>
        <details>
            <summary>Partition Metrics ({{ partition_metrics|length }})</summary>
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 15%;">Partition</th>
                            <th class="number" style="width: 25%;">Offset</th>
                            <th class="number" style="width: 20%;">Lag</th>
                            <th style="width: 40%;">Assigned Worker</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pm in partition_metrics %}
                        <tr>
                            <td>{{ pm.partition_id }}</td>
                            <td class="number">{{ pm.offset|default(0)|format_number }}</td>
                            <td class="number">{{ pm.lag|default(0)|format_number }}</td>
                            <td class="monospace" style="font-size: 0.75rem;">{{ (pm.assigned_worker|default('-'))[:12] }}{% if pm.assigned_worker and pm.assigned_worker|length > 12 %}...{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    </section>
    {% endif %}
    
    <!-- Queue History Chart -->
    <section>
        <h3>Queue Size History</h3>
        <div style="height: 200px; position: relative;">
            <canvas id="queueChart"></canvas>
        </div>
    </section>
    
    <!-- Back link -->
    <section>
        <a href="{{ base_path }}/jobs/{{ job_id }}/" role="button" class="outline small">← Back to Job</a>
    </section>
</article>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    const jobId = '{{ job_id }}';
    const stageId = '{{ stage.stage_id }}';
    const basePath = '{{ base_path }}';
    
    // Queue history data
    const MAX_POINTS = 60;
    let queueData = {
        labels: [],
        datasets: [{
            label: 'Queue Size',
            data: [],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            fill: true,
            tension: 0.3
        }]
    };
    
    // Initialize chart
    const ctx = document.getElementById('queueChart');
    if (!ctx) return;
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: queueData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { 
                    display: true,
                    title: { display: false }
                },
                y: { 
                    beginAtZero: true,
                    title: { display: true, text: 'Records' }
                }
            },
            animation: { duration: 0 }
        }
    });
    
    // Load historical data from API
    async function loadHistoricalData() {
        try {
            const response = await fetch(`${basePath}/api/jobs/${jobId}/stages/${stageId}/metrics-history`);
            if (response.ok) {
                const result = await response.json();
                if (result.data && result.data.length > 0) {
                    // Clear existing data
                    queueData.labels = [];
                    queueData.datasets[0].data = [];
                    
                    // Add historical data
                    result.data.forEach(point => {
                        const date = new Date(point.timestamp * 1000);
                        queueData.labels.push(date.toLocaleTimeString());
                        queueData.datasets[0].data.push(point.queue_size);
                    });
                    
                    chart.update();
                    return;
                }
            }
        } catch (e) {
            console.log('Failed to load historical data:', e);
        }
        
        // Fallback: add current value if no history
        const currentQueueSize = {{ stage.output_queue_size|default(0) }};
        const now = new Date().toLocaleTimeString();
        queueData.labels.push(now);
        queueData.datasets[0].data.push(currentQueueSize);
        chart.update();
    }
    
    // Load history on page load
    loadHistoricalData();
    
    // Helper to read current queue size from the page
    let currentQueueSize = {{ stage.output_queue_size|default(0) }};
    function readQueueSizeFromPage() {
        const metricCards = document.querySelectorAll('.metric-card');
        if (metricCards.length >= 2) {
            const queueCard = metricCards[1];
            const valueEl = queueCard.querySelector('.metric-value');
            if (valueEl) {
                const text = valueEl.textContent.trim();
                const num = parseFloat(text.replace(/[^\d.]/g, ''));
                if (text.includes('K')) return num * 1000;
                if (text.includes('M')) return num * 1000000;
                if (text.includes('B')) return num * 1000000000;
                return num || 0;
            }
        }
        return currentQueueSize;
    }
    
    // Update chart when HTMX refreshes the page (for live updates)
    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target && e.detail.target.classList.contains('compact')) {
            setTimeout(() => {
                currentQueueSize = readQueueSizeFromPage();
                
                const time = new Date().toLocaleTimeString();
                if (queueData.labels.length >= MAX_POINTS) {
                    queueData.labels.shift();
                    queueData.datasets[0].data.shift();
                }
                queueData.labels.push(time);
                queueData.datasets[0].data.push(currentQueueSize);
                chart.update();
            }, 100);
        }
    });
})();
</script>
{% endblock %}
